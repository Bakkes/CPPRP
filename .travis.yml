language: shell
python:
    - "3.6"


git:
  submodules: false
# Use sed to replace the SSH URL with the public URL, then initialize submodules
before_install:
  - sed -i 's/git@github.com:/https:\/\/github.com\//' ".gitmodules"
  - git submodule update --init --recursive

matrix:
  include:
        - compiler: clang
          os: linux
          dist: xenial
          addons:
            apt:
              sources: ['ubuntu-toolchain-r-test', 'llvm-toolchain-xenial-8']
              packages: ['g++-9', 'clang++-8', 'clang-tidy-8']
          env:
            - NAME=clang8
            - CXX=clang++-8
            - CLANG_TIDY=clang-tidy-8
          script:
            - make RELEASE=1
        - compiler: gcc
          os: linux
          dist: xenial
          addons:
            apt:
              sources: ['ubuntu-toolchain-r-test']
              packages: ['g++-9']
          env:
            - NAME=gcc
            - CXX=g++-9
          script:
            - make RELEASE=1
        - os: windows
          env:
            - MSBUILD_PATH="C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\MSBuild\Current\Bin"
            - PYTHON_PATH="C:/Python37:C:/Python37/Scripts:/c/Python37:/c/Python37/Scripts"
            #:/c/Python37/Scripts:$PATH
          install:
            - choco install python --version=3.7.2
            - choco install visualstudio2019buildtools --package-parameters "--add Microsoft.VisualStudio.Component.VC.Tools.x86.x64"
#            - choco install dotnetcore-sdk
#            - dotnet restore
          script:
            - export PATH=$PYTHON_PATH:$MSBUILD_PATH:$PATH
            - ./buildwindows.bat
    
notifications:
  email: false
  
before_deploy:
      # Set up git user name and tag this commit
      #- git config --local user.name "YOUR GIT USER NAME"
      #- git config --local user.email "YOUR GIT USER EMAIL"
      #- export TRAVIS_TAG=${TRAVIS_TAG:-$(date +'%Y%m%d%H%M%S')-$(git log --format=%h -1)}
      #- git tag $TRAVIS_TAG
      if [ "$TRAVIS_OS_NAME" == "windows" ]; then 
        copy "./x64/JSONBuild/CPPRPJSON.exe" "cpprpjson-$NAME-$TRAVIS_TAG.exe"; 
        copy "./x64/JSONBuild/CPPRP.lib" "cpprp-$NAME-$TRAVIS_TAG.lib"; 
      fi
      
      if [ "$TRAVIS_OS_NAME" != "windows" ]; then mv "./build/test" "cpprp-$NAME-$TRAVIS_TAG"; fi

deploy:
  - provider: releases
    api_key: 
      secure: "usGhKGnsm91KZMtewhMHEB7AhSg46i7RowTnfAG/tlGhvlaHgAOh+1zeoKBtFdhJ/qxjFwGkwQ9AaY429JT1K81KkweCQ7gWeDHBN6+096GqYGfr+SdA31dj6x+Nl+eT6u/CzmqiL7kGukzWzEA9YWzr/wUppC+b2UIsugkzcsS7IBzrlTWnbChLPVsF0Vo2/QDt8tQRBXUXb+/TnQ5AenfTdRlcCTPyy51GOVDULRH5+rQJWTxVKWcW50JIY+pLQyr/WVvPsdp3EtEufYzTpfMWVvNn1zTqoizKquTCQTxjpoj5bn5eQTQSTN/l6m919xv9RjU0WVE0cNLW8C8xrqt6cPwVPmCzY6UR0XBzlGTSkX1tPTV81FLTSFlWLi/InoIM7e3TCDmuo9CvSAS0IyyGwMaLGV+CY597s0ScwkYnK3uFCSpp/loF1Ua6SeG43xCxgL38fVjCuJUnW8Fe6Mt6bC5x1+JC3O0v0s+Jb0pxflEfnMjGRrb2ENxdu0aoAZ8cWv5oQIiwSBv5LgDI+HzRScYsFvjZkiuNkiYdr8ooOseQ+HGddUbcb7QB+DxTH83+krmP3rnOsyeFMjUkqbmDOwz+IudDdX+JP4ZkYMZee9yzXvlKH6BaMLDKheX5QJrtYn9tQM5OKlAnK070WUTMtXXpcpP6AHuznpU+9pQ="
    file: "cpprp-$NAME-$TRAVIS_TAG"
    skip_cleanup: true
    draft: true
    on:
      os: linux
      tags: true
      branch: master
  - provider: releases
    api_key: 
      secure: "usGhKGnsm91KZMtewhMHEB7AhSg46i7RowTnfAG/tlGhvlaHgAOh+1zeoKBtFdhJ/qxjFwGkwQ9AaY429JT1K81KkweCQ7gWeDHBN6+096GqYGfr+SdA31dj6x+Nl+eT6u/CzmqiL7kGukzWzEA9YWzr/wUppC+b2UIsugkzcsS7IBzrlTWnbChLPVsF0Vo2/QDt8tQRBXUXb+/TnQ5AenfTdRlcCTPyy51GOVDULRH5+rQJWTxVKWcW50JIY+pLQyr/WVvPsdp3EtEufYzTpfMWVvNn1zTqoizKquTCQTxjpoj5bn5eQTQSTN/l6m919xv9RjU0WVE0cNLW8C8xrqt6cPwVPmCzY6UR0XBzlGTSkX1tPTV81FLTSFlWLi/InoIM7e3TCDmuo9CvSAS0IyyGwMaLGV+CY597s0ScwkYnK3uFCSpp/loF1Ua6SeG43xCxgL38fVjCuJUnW8Fe6Mt6bC5x1+JC3O0v0s+Jb0pxflEfnMjGRrb2ENxdu0aoAZ8cWv5oQIiwSBv5LgDI+HzRScYsFvjZkiuNkiYdr8ooOseQ+HGddUbcb7QB+DxTH83+krmP3rnOsyeFMjUkqbmDOwz+IudDdX+JP4ZkYMZee9yzXvlKH6BaMLDKheX5QJrtYn9tQM5OKlAnK070WUTMtXXpcpP6AHuznpU+9pQ="
    file:
      - "cpprp-$NAME-$TRAVIS_TAG.lib"
      - "cpprpjson-$NAME-$TRAVIS_TAG.exe"
    skip_cleanup: true
    draft: true
    on:
      os: linux
      tags: true
      branch: master      
      
      
branches:
  only:
    - master
    - /^\d+\.\d+\.\d+.*$/ #https://travis-ci.community/t/pushing-tag-does-not-trigger-deployment-to-github-releases/3098
