language: shell
python:
    - "3.6"


git:
  submodules: false
# Use sed to replace the SSH URL with the public URL, then initialize submodules
before_install:
  - sed -i 's/git@github.com:/https:\/\/github.com\//' ".gitmodules"
  - git submodule update --init --recursive

matrix:
  include:
        - compiler: clang
          os: linux
          dist: xenial
          addons:
            apt:
              sources: ['ubuntu-toolchain-r-test', 'llvm-toolchain-xenial-8']
              packages: ['g++-9', 'clang++-8', 'clang-tidy-8']
          env:
            - NAME=clang8
            - CXX=clang++-8
            - CLANG_TIDY=clang-tidy-8
          script:
            - make RELEASE=1
        - compiler: gcc
          os: linux
          dist: xenial
          addons:
            apt:
              sources: ['ubuntu-toolchain-r-test']
              packages: ['g++-9']
          env:
            - NAME=gcc
            - CXX=g++-9
          script:
            - make RELEASE=1
        - os: windows
          env:
            - MSBUILD_PATH="C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\MSBuild\Current\Bin"
            - PYTHON_PATH="C:/Python37:C:/Python37/Scripts:/c/Python37:/c/Python37/Scripts"
            #:/c/Python37/Scripts:$PATH
          install:
            - choco install python --version=3.7.2
            - choco install visualstudio2019buildtools --package-parameters "--add Microsoft.VisualStudio.Component.VC.Tools.x86.x64"
#            - choco install dotnetcore-sdk
#            - dotnet restore
          script:
            - export PATH=$PYTHON_PATH:$MSBUILD_PATH:$PATH
            - ./buildwindows.bat
    
notifications:
  email: false
  
before_deploy:
      # Set up git user name and tag this commit
      #- git config --local user.name "YOUR GIT USER NAME"
      #- git config --local user.email "YOUR GIT USER EMAIL"
      #- export TRAVIS_TAG=${TRAVIS_TAG:-$(date +'%Y%m%d%H%M%S')-$(git log --format=%h -1)}
      #- git tag $TRAVIS_TAG
      if [ "$TRAVIS_OS_NAME" == "windows" ]; then 
        copy "./x64/JSONBuild/CPPRPJSON.exe" "cpprpjson-$NAME-$TRAVIS_TAG.exe"; 
        copy "./x64/JSONBuild/CPPRP.lib" "cpprp-$NAME-$TRAVIS_TAG.lib"; 
      fi
      
      if [ "$TRAVIS_OS_NAME" != "windows" ]; then mv "./build/test" "cpprp-$NAME-$TRAVIS_TAG"; fi

deploy:
  - provider: releases
    github_token: 
      secure: "v5/Vm/Xd271RvY40613wVypv2N6WIABAlE2CN2Kbof19bmZ3JK0djjy8b6cdP0Z+yg0+u4xPLC6XDdR7kuIzsWVvzCRXGHM9orio1/kXmjCBtDxF4Ea1Do4SHTZK2CFzIq591adSrwh7MdXPFXNe3hk/oG9tXP8B8Gk69ltqzJ3KEqBeW4EI/ana7QjPnZNPS2sby5ZBzz9gFgXbU6MSAQ4z9vKDUyl5DZZZTQtwDO08QLBh7s2pOVIJroWkT5uYbwZL8hGvaUqMMwz/Gpd/kSLnbKV9IzV/WwmxNvqm/HuiEFW+0fXSh4LkaavetqPJMVlm+jJLZoetdqtchXRr2qjhMOLk9Y4V/C7E9uhAtmHOP+5iFXtOZTehG739W06u+Aq+b0IGFAdBTnCtD9Kfe2+G86Dl6zTldRHvOIyBA4SIb4KYpdThFo4N+BnIrqB1xeKDhJJiO88DpZQPVtjg69NrKclHzv5BZKVndY5OwPay5Yi//8W9k8U8s5akFf7VnPM4hn0wBdEo6fJBPIHdDa95ZFI7vS2imHOJRhnW7iTPEqkPIrugrTmfvEN9idr+epmoWbQhZ38n6RJuKUWEQCtrpQKKmq51mpQ3qADx/iLgBR5uspOzg2yZMXXxBCBMkp6O/9ttubzvY/NQfaJXhmEFJrmwDWBnWf8s7UnyBY8="
    file: "cpprp-$NAME-$TRAVIS_TAG"
    skip_cleanup: true
    draft: true
    on:
      os: linux
      #tags: true
      branch: master
  - provider: releases
    github_token: 
      secure: "v5/Vm/Xd271RvY40613wVypv2N6WIABAlE2CN2Kbof19bmZ3JK0djjy8b6cdP0Z+yg0+u4xPLC6XDdR7kuIzsWVvzCRXGHM9orio1/kXmjCBtDxF4Ea1Do4SHTZK2CFzIq591adSrwh7MdXPFXNe3hk/oG9tXP8B8Gk69ltqzJ3KEqBeW4EI/ana7QjPnZNPS2sby5ZBzz9gFgXbU6MSAQ4z9vKDUyl5DZZZTQtwDO08QLBh7s2pOVIJroWkT5uYbwZL8hGvaUqMMwz/Gpd/kSLnbKV9IzV/WwmxNvqm/HuiEFW+0fXSh4LkaavetqPJMVlm+jJLZoetdqtchXRr2qjhMOLk9Y4V/C7E9uhAtmHOP+5iFXtOZTehG739W06u+Aq+b0IGFAdBTnCtD9Kfe2+G86Dl6zTldRHvOIyBA4SIb4KYpdThFo4N+BnIrqB1xeKDhJJiO88DpZQPVtjg69NrKclHzv5BZKVndY5OwPay5Yi//8W9k8U8s5akFf7VnPM4hn0wBdEo6fJBPIHdDa95ZFI7vS2imHOJRhnW7iTPEqkPIrugrTmfvEN9idr+epmoWbQhZ38n6RJuKUWEQCtrpQKKmq51mpQ3qADx/iLgBR5uspOzg2yZMXXxBCBMkp6O/9ttubzvY/NQfaJXhmEFJrmwDWBnWf8s7UnyBY8="
    file:
      - "cpprp-$NAME-$TRAVIS_TAG.lib"
      - "cpprpjson-$NAME-$TRAVIS_TAG.exe"
    skip_cleanup: true
    draft: true
    on:
      os: linux
      #tags: true
      branch: master      
      
      
branches:
  only:
    - master
    - /^\d+\.\d+\.\d+.*$/ #https://travis-ci.community/t/pushing-tag-does-not-trigger-deployment-to-github-releases/3098
