language: shell
python:
    - "3.6"


git:
  submodules: false
# Use sed to replace the SSH URL with the public URL, then initialize submodules
before_install:
  - sed -i 's/git@github.com:/https:\/\/github.com\//' ".gitmodules"
  - git submodule update --init --recursive

matrix:
  include:
        - compiler: clang
          os: linux
          dist: xenial
          addons:
            apt:
              sources: ['ubuntu-toolchain-r-test', 'llvm-toolchain-xenial-8']
              packages: ['g++-9', 'clang++-8', 'clang-tidy-8']
          env:
            - NAME=clang8
            - CXX=clang++-8
            - CLANG_TIDY=clang-tidy-8
          script:
            - make RELEASE=1
        - compiler: gcc
          os: linux
          dist: xenial
          addons:
            apt:
              sources: ['ubuntu-toolchain-r-test']
              packages: ['g++-9']
          env:
            - NAME=gcc
            - CXX=g++-9
          script:
            - make RELEASE=1
        - os: windows
          env:
            - MSBUILD_PATH="C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\MSBuild\Current\Bin"
            - PYTHON_PATH="C:/Python37:C:/Python37/Scripts:/c/Python37:/c/Python37/Scripts"
            #:/c/Python37/Scripts:$PATH
          install:
            - choco install python --version=3.7.2
            - choco install visualstudio2019buildtools --package-parameters "--add Microsoft.VisualStudio.Component.VC.Tools.x86.x64"
#            - choco install dotnetcore-sdk
#            - dotnet restore
          script:
            - export PATH=$PYTHON_PATH:$MSBUILD_PATH:$PATH
            - ./buildwindows.bat
    
notifications:
  email: false
  
before_deploy:
      # Set up git user name and tag this commit
      #- git config --local user.name "YOUR GIT USER NAME"
      #- git config --local user.email "YOUR GIT USER EMAIL"
      #- export TRAVIS_TAG=${TRAVIS_TAG:-$(date +'%Y%m%d%H%M%S')-$(git log --format=%h -1)}
      #- git tag $TRAVIS_TAG
      if [ "$TRAVIS_OS_NAME" == "windows" ]; then 
        copy "./x64/JSONBuild/CPPRPJSON.exe" "cpprpjson-$NAME-$TRAVIS_TAG.exe"; 
        copy "./x64/JSONBuild/CPPRP.lib" "cpprp-$NAME-$TRAVIS_TAG.lib"; 
      fi
      
      if [ "$TRAVIS_OS_NAME" != "windows" ]; then mv "./build/test" "cpprp-$NAME-$TRAVIS_TAG"; fi

deploy:
  - provider: releases
    api_key: 
      secure: "iSpKRqlXksjnRHrgAAaj0MooeM+RmCu025/+H21kwFisGj8GaopAEWuNZofG+p4dvDIpRCFSDaF6mn/o2/6D+d0dFMRbiVlcsFayCv59WHXFWFNE5/mdc9fUZb6aGFz49uL5YOVx6D1SUPPlRCTcYJGmnSQf9SKWeQ85T9NpRq/Rl4ic0JB5gaWfNEOBAfOwp/Lu2g5lQ+0694kIekLKvKqoG7oRh8xihJLt6KVNtLHxWIw0riZjv9ML+Ekt05rz2fxx0B3NdvGmSGYAFkcXJta67rWMawMHKOfsZ++DnCFmqO5lB/uMrpUGH0r9z9hGmn+LHJ8HQ9HxAxfUJx4p5PUiGLZ9ltGEgqWFN1Sqk3tFwb3xIjHt3W1cyIXNYrjoJnjpDUUrwCO1DOIJFbNV1dIbAK6FHHPwVIs3EmbZA5MuVbO3jn/Dy1nUl+APwmufrl1u9FaakvwUl/iQLJXD4ce31mvZozRIXuO+O50uhGP/FgAGG9dASkB+oiLmc8d9/BLEHFsNfRkEKAML6ogIiLAvE2xaSYGaMmArI2AuIgXNzEx0Kjq7BEJliPHAHmJNoJ+VEetqR8TmE4kQdAEanLz6SpBHbmLiyMgwk16TUA2P9yuh2xqzWT/mKoGpZi9OmTAtfWvl0YNrHksTKhyoCjySxbWkgtsyAiQqNBlO9Xo="
    file: "cpprp-$NAME-$TRAVIS_TAG"
    skip_cleanup: true
    draft: true
    on:
      os: linux
      tags: true
      branch: master
  - provider: releases
    api_key: 
      secure: "iSpKRqlXksjnRHrgAAaj0MooeM+RmCu025/+H21kwFisGj8GaopAEWuNZofG+p4dvDIpRCFSDaF6mn/o2/6D+d0dFMRbiVlcsFayCv59WHXFWFNE5/mdc9fUZb6aGFz49uL5YOVx6D1SUPPlRCTcYJGmnSQf9SKWeQ85T9NpRq/Rl4ic0JB5gaWfNEOBAfOwp/Lu2g5lQ+0694kIekLKvKqoG7oRh8xihJLt6KVNtLHxWIw0riZjv9ML+Ekt05rz2fxx0B3NdvGmSGYAFkcXJta67rWMawMHKOfsZ++DnCFmqO5lB/uMrpUGH0r9z9hGmn+LHJ8HQ9HxAxfUJx4p5PUiGLZ9ltGEgqWFN1Sqk3tFwb3xIjHt3W1cyIXNYrjoJnjpDUUrwCO1DOIJFbNV1dIbAK6FHHPwVIs3EmbZA5MuVbO3jn/Dy1nUl+APwmufrl1u9FaakvwUl/iQLJXD4ce31mvZozRIXuO+O50uhGP/FgAGG9dASkB+oiLmc8d9/BLEHFsNfRkEKAML6ogIiLAvE2xaSYGaMmArI2AuIgXNzEx0Kjq7BEJliPHAHmJNoJ+VEetqR8TmE4kQdAEanLz6SpBHbmLiyMgwk16TUA2P9yuh2xqzWT/mKoGpZi9OmTAtfWvl0YNrHksTKhyoCjySxbWkgtsyAiQqNBlO9Xo="
    file:
      - "cpprp-$NAME-$TRAVIS_TAG.lib"
      - "cpprpjson-$NAME-$TRAVIS_TAG.exe"
    skip_cleanup: true
    draft: true
    on:
      os: linux
      tags: true
      branch: master      
      
      
branches:
  only:
    - master
    - /^\d+\.\d+\.\d+.*$/ #https://travis-ci.community/t/pushing-tag-does-not-trigger-deployment-to-github-releases/3098
