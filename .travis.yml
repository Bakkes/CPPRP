language: shell
python:
    - "3.6"


git:
  submodules: false
# Use sed to replace the SSH URL with the public URL, then initialize submodules
before_install:
  - sed -i 's/git@github.com:/https:\/\/github.com\//' ".gitmodules"
  - git submodule update --init --recursive

matrix:
  include:
        - compiler: clang
          os: linux
          dist: xenial
          addons:
            apt:
              sources: ['ubuntu-toolchain-r-test', 'llvm-toolchain-xenial-8']
              packages: ['g++-9', 'clang++-8', 'clang-tidy-8']
          env:
            - NAME=clang8
            - CXX=clang++-8
            - CLANG_TIDY=clang-tidy-8
          script:
            - make RELEASE=1
        - compiler: gcc
          os: linux
          dist: xenial
          addons:
            apt:
              sources: ['ubuntu-toolchain-r-test']
              packages: ['g++-9']
          env:
            - NAME=gcc
            - CXX=g++-9
          script:
            - make RELEASE=1
        - os: windows
          env:
            - MSBUILD_PATH="C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\MSBuild\Current\Bin"
            - PYTHON_PATH="C:/Python37:C:/Python37/Scripts:/c/Python37:/c/Python37/Scripts"
            #:/c/Python37/Scripts:$PATH
          install:
            - choco install python --version=3.7.2
            - choco install visualstudio2019buildtools --package-parameters "--add Microsoft.VisualStudio.Component.VC.Tools.x86.x64"
#            - choco install dotnetcore-sdk
#            - dotnet restore
          script:
            - export PATH=$PYTHON_PATH:$MSBUILD_PATH:$PATH
            - ./buildwindows.bat
    
notifications:
  email: false
  
before_deploy:
      # Set up git user name and tag this commit
      #- git config --local user.name "YOUR GIT USER NAME"
      #- git config --local user.email "YOUR GIT USER EMAIL"
      #- export TRAVIS_TAG=${TRAVIS_TAG:-$(date +'%Y%m%d%H%M%S')-$(git log --format=%h -1)}
      #- git tag $TRAVIS_TAG
      if [ "$TRAVIS_OS_NAME" == "windows" ]; then 
        copy "./x64/JSONBuild/CPPRPJSON.exe" "cpprpjson-$NAME-$TRAVIS_TAG.exe"; 
        copy "./x64/JSONBuild/CPPRP.lib" "cpprp-$NAME-$TRAVIS_TAG.lib"; 
      fi
      
      if [ "$TRAVIS_OS_NAME" != "windows" ]; then mv "./build/test" "cpprp-$NAME-$TRAVIS_TAG"; fi

deploy:
  - provider: releases
    api_key: 
      secure: "miNcbt/9DgFsntnA/bHQySogWlq8Vhci8aMple/tNk3hf0D/kkK50CzYjPvbLAn3kaq0Mnh0E6IzN0wKpjIY75LFNHAQtDT6uehW8GlGaUMOZwjTe2QGgRy5yUwBBy4gQq3OZSkFndoZ/q9KKJP949otWX1PuiPQ9VNdlwF38GWzjfxK9jr//rylHv8RAZw3BKXIoBs6uBW/m7KRs/ufvnZgLFHH82piCTeA1tujtmh0Rp9j3uctkG3Rh8nRAs7MM7bL3NUhQFUaSswTEDUZEgMNpXE0n+ZcVkoxWY62V3nikNNKGv1lZqkDvfD9pfwlZQAN+YZkuw3KGNPMnE9RYUQ1Bvpl6KJmHnQTUjiHo79UYQcaz5zsPasnPJurrJMBZ9J/q1ImdeCBRx7EGUDrXQvvcjYVCjcLLqSFzG4YJOGrWtjmqrGFR3SCGtwt7oTqRpXU4wd83eCVLo8D3qj5UPyB/IReHZUeDdAMkH2qmVdL8bWnsTBH4iSbrfNqyFEt1v8IpisJbJwgVNp1Rs1BLUV5qPVChshHEc2iSA1EZH/UmpnjEX2WxT4NQS8foxEBEWcLbBsj7Qnqy/piw3qudGhEuobBDpz9ZUll6qy3oy3iSEo4lmLVmFU4OwRTqZQl2zPDdfgDo/xXuD5hAWZ/b02ZnjXWDfGBw/Cbp2svSko="
    file: "cpprp-$NAME-$TRAVIS_TAG"
    skip_cleanup: true
    draft: true
    on:
      os: linux
      tags: true
      branch: master
  - provider: releases
    api_key: 
      secure: "miNcbt/9DgFsntnA/bHQySogWlq8Vhci8aMple/tNk3hf0D/kkK50CzYjPvbLAn3kaq0Mnh0E6IzN0wKpjIY75LFNHAQtDT6uehW8GlGaUMOZwjTe2QGgRy5yUwBBy4gQq3OZSkFndoZ/q9KKJP949otWX1PuiPQ9VNdlwF38GWzjfxK9jr//rylHv8RAZw3BKXIoBs6uBW/m7KRs/ufvnZgLFHH82piCTeA1tujtmh0Rp9j3uctkG3Rh8nRAs7MM7bL3NUhQFUaSswTEDUZEgMNpXE0n+ZcVkoxWY62V3nikNNKGv1lZqkDvfD9pfwlZQAN+YZkuw3KGNPMnE9RYUQ1Bvpl6KJmHnQTUjiHo79UYQcaz5zsPasnPJurrJMBZ9J/q1ImdeCBRx7EGUDrXQvvcjYVCjcLLqSFzG4YJOGrWtjmqrGFR3SCGtwt7oTqRpXU4wd83eCVLo8D3qj5UPyB/IReHZUeDdAMkH2qmVdL8bWnsTBH4iSbrfNqyFEt1v8IpisJbJwgVNp1Rs1BLUV5qPVChshHEc2iSA1EZH/UmpnjEX2WxT4NQS8foxEBEWcLbBsj7Qnqy/piw3qudGhEuobBDpz9ZUll6qy3oy3iSEo4lmLVmFU4OwRTqZQl2zPDdfgDo/xXuD5hAWZ/b02ZnjXWDfGBw/Cbp2svSko="
    file:
      - "cpprp-$NAME-$TRAVIS_TAG.lib"
      - "cpprpjson-$NAME-$TRAVIS_TAG.exe"
    skip_cleanup: true
    draft: true
    on:
      os: linux
      tags: true
      branch: master      
      
      
branches:
  only:
    - master
    - /^\d+\.\d+\.\d+.*$/ #https://travis-ci.community/t/pushing-tag-does-not-trigger-deployment-to-github-releases/3098
